# === Stage 1: Build the Angular Application ===
# Use Node 20 or 21, as you are using Angular 21
FROM node:20.19.0-alpine AS build

WORKDIR /app

# Set memory limits to prevent build failures on restricted environments
ENV NODE_OPTIONS=--max_old_space_size=4096 

# Copy package.json and package-lock.json first to leverage Docker cache
COPY package*.json ./
RUN npm install

# Copy the rest of the application code
COPY . .

# Build the Angular application for production
# We add --output-path=dist/browser for a consistent path
RUN npm run build --configuration=production

# === Stage 2: Serve the Application with Nginx ===
# Use a lightweight Nginx image to serve the static files
FROM nginx:stable-alpine

# Copy the custom Nginx configuration file into the container
COPY nginx.conf /etc/nginx/nginx.conf
#COPY nginx.conf /etc/nginx/conf.d/default.conf

# Copy the built application files from the 'build' stage to the Nginx public directory
# We copy from the consistent path we defined in the build stage
COPY --from=build /app/dist/data-engineering-portal/browser/ /usr/share/nginx/html

# Expose port 80 (default Nginx port)
EXPOSE 80

# Copy the wait script and make it executable
# COPY wait-for-services.sh /usr/local/bin/wait-for-services.sh
# RUN chmod +x /usr/local/bin/wait-for-services.sh

# Change the CMD to run our script first, passing the original Nginx command as arguments
# CMD ["/usr/local/bin/wait-for-services.sh", "nginx", "-g", "daemon off;"]

# Command to run Nginx in the foreground
CMD ["nginx", "-g", "daemon off;"]
